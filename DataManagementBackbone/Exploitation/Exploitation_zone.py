import pandas as pd
import numpy as np
import os 
import csv
import datetime
from sqlalchemy import create_engine

def exploitation():

    conn_string = 'postgresql://biel.caballero:DB130201@postgresfib.fib.upc.edu:6433/ADSDBbiel.caballero'
    db = create_engine(conn_string)
    
    SELECT_BETS = "select * from tennis_datav2"
    with db.connect() as conn:
        bets = pd.read_sql_query(SELECT_BETS, conn)
    bets["tournament"] = bets["tournament"].astype("category")

    SELECT_ATP = "select * from atpdatav3"
    with db.connect() as conn:
        atp = pd.read_sql_query(SELECT_ATP, conn)
    atp["tourney_name"] = atp["tourney_name"].astype("category")

    atp = atp.rename(columns={'tourney_name': 'tournament', 'winner_name': 'winner', 'loser_name' : 'loser'})

    merged_dataframe = pd.merge(atp, bets, how = "inner", on = ["winner","loser","tournament"])
    merged_dataframe.head()
    merged_dataframe = merged_dataframe.replace({np.NaN: None})

    merged_dataframe=merged_dataframe.drop(['tourney_date','first_set','second_set','third_set','fourth_set','fifth_set','Surface','round_y',
                        'best_of_y','wrank','lrank','wpts','lpts','psw','psl','maxw','maxl','avgw','avgl'], axis=1)

    conn = db.connect()
    merged_dataframe.to_sql('mergedtables', con=conn, if_exists='replace', index = False)

